<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Synthetic Prices</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      :root {
        --primary-color: #3b82f6;
        --secondary-color: #6366f1;
        --background-color: #f8fafc;
        --card-background: rgba(255, 255, 255, 0.9);
        --text-color: #1e293b;
        --gradient-start: #4f46e5;
        --gradient-end: #9333ea;
        --border-radius: 20px;
        --gap: 2rem;
        --rsi-color: #ffa500;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --background-color: #0f172a;
          --card-background: rgba(30, 41, 59, 0.9);
          --text-color: #f8fafc;
          --gradient-start: #818cf8;
          --gradient-end: #c084fc;
        }
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", system-ui, sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
        min-height: 100vh;
        padding: 1rem; /* Reduced from 2rem */
        overflow-x: hidden; /* Prevent horizontal scroll */
      }

      .container {
        max-width: 100%; /* Changed from 1600px */
        padding: 0 1rem; /* Add horizontal padding */
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: var(--gap);
      }

      .header {
        width: 100%;
        display: flex;
        justify-content: center;
        padding: 20px 0;
        background: #f0f0f0;
        background: var(--card-background);
        border-radius: var(--border-radius);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 2rem;
        z-index: 100;
        padding: 1.5rem;
      }

      .header-content {
        display: flex;
        width: 80%;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 1.75rem;
        background: linear-gradient(
          45deg,
          var(--gradient-start),
          var(--gradient-end)
        );
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        font-weight: 700;
        letter-spacing: -0.025em;
      }

      .button-group {
        display: flex;
        gap: 20px;
      }

      .button svg {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .button.active svg {
        transform: rotate(180deg);
      }

      .chart-container {
        width: 100%;
        height: 75vh;
        min-height: 600px;
        background: var(--card-background);
        border-radius: var(--border-radius);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin: 0 auto;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1.5rem;
      }

      .plot-container {
        margin: 0 auto;
      }

      .button {
        background: linear-gradient(
          45deg,
          var(--gradient-start),
          var(--gradient-end)
        );
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: calc(var(--border-radius) / 2);
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(var(--gradient-start), 0.3);
      }

      .button:active {
        transform: translateY(0);
      }

      .button svg {
        transition: transform 0.3s ease;
      }

      .button.active {
        background: var(--card-background);
        color: var(--text-color);
        box-shadow: inset 0 0 0 2px var(--primary-color);
      }

      footer {
        text-align: center;
        margin-top: auto;
        padding: 2rem;
        color: rgba(148, 163, 184, 0.8);
        font-size: 0.875rem;
        opacity: 0.8;
        transition: opacity 0.3s ease;
      }

      footer:hover {
        opacity: 1;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 4px;
      }

      /* Add these new styles */
      .indicator-menu {
        position: relative;
        /* display: inline-block; */
        display: flex;
        flex-direction: row;
        gap: 1rem;
        padding: 5px;
      }

      .indicator-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background: var(--card-background);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        padding: 1rem;
        min-width: 200px;
        z-index: 1000;
        margin-top: 0.5rem;
        backdrop-filter: blur(10px);
      }

      .indicator-dropdown.show {
        display: block;
        animation: slideIn 0.3s ease;
      }

      .indicator-item {
        padding: 0.75rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin: 0.25rem 0;
      }

      .indicator-item:hover {
        background: rgba(var(--gradient-start), 0.1);
        transform: translateX(4px);
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div class="header-content">
          <h1>ðŸ“ˆ Analytics Dashboard</h1>
          <div class="button-group">
            <div class="indicator-menu">
              <button
                class="button"
                onclick="toggleIndicatorMenu()"
                id="indicatorButton"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M6 9l6 6 6-6" />
                </svg>
                <span>Add Indicator</span>
              </button>
              <button
                class="button"
                id="logScaleBtn"
                onclick="toggleLogScale()"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M3 3v18h18" />
                  <path d="M18 17V9" />
                  <path d="M13 17V5" />
                  <path d="M8 17v-3" />
                </svg>
                <span>Log Scale</span>
              </button>
              <div class="indicator-dropdown" id="indicatorDropdown">
                <div class="indicator-item" onclick="addIndicator('sma')">
                  SMA (20)
                </div>
                <div class="indicator-item" onclick="addIndicator('ema')">
                  EMA (20)
                </div>
                <div class="indicator-item" onclick="addIndicator('rsi')">
                  RSI (14)
                </div>
                <div class="indicator-item" onclick="addIndicator('macd')">
                  MACD
                </div>
                <div class="indicator-item" onclick="addIndicator('bollinger')">
                  Bollinger Bands
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="chart-container" id="my-plot-id">
        <!-- PLOT_PLACEHOLDER -->
      </div>

      <footer>
        <p>
          Powered by Rust + Plotly â€¢ Generated at <span id="timestamp"></span>
        </p>
        <p style="margin-top: 0.5rem; opacity: 0.7">
          Toggle scale type for detailed analysis
        </p>
      </footer>
    </div>

    <script>
      // Technical indicator functions
      function calculateSMA(data, period = 20) {
        const sma = [];
        for (let i = period - 1; i < data.length; i++) {
          const sum = data
            .slice(i - period + 1, i + 1)
            .reduce((a, b) => a + b.y, 0);
          sma.push({ x: data[i].x, y: sum / period });
        }
        return sma;
      }

      function calculateEMA(data, period = 20) {
        const ema = [];
        const multiplier = 2 / (period + 1);
        let emaValue =
          data.slice(0, period).reduce((a, b) => a + b.y, 0) / period;

        for (let i = period; i < data.length; i++) {
          emaValue = (data[i].y - emaValue) * multiplier + emaValue;
          ema.push({ x: data[i].x, y: emaValue });
        }
        return ema;
      }

      function calculateRSI(data, period = 14) {
        const rsi = [];
        let gains = [];
        let losses = [];

        // Initial calculation
        for (let i = 1; i <= period; i++) {
          const diff = data[i].y - data[i - 1].y;
          gains.push(Math.max(diff, 0));
          losses.push(Math.max(-diff, 0));
        }

        let avgGain = gains.reduce((a, b) => a + b, 0) / period;
        let avgLoss = losses.reduce((a, b) => a + b, 0) / period;

        for (let i = period + 1; i < data.length; i++) {
          const diff = data[i].y - data[i - 1].y;
          const gain = Math.max(diff, 0);
          const loss = Math.max(-diff, 0);

          avgGain = (avgGain * (period - 1) + gain) / period;
          avgLoss = (avgLoss * (period - 1) + loss) / period;

          const rs = avgGain / avgLoss;
          rsi.push({ x: data[i].x, y: 100 - 100 / (1 + rs) });
        }
        return rsi;
      }

      // Indicator menu functions
      function toggleIndicatorMenu() {
        const dropdown = document.getElementById("indicatorDropdown");
        const button = document.getElementById("indicatorButton");

        dropdown.classList.toggle("show");
        button.classList.toggle("active");
      }

      // Close dropdown when clicking outside
      window.onclick = function (event) {
        if (!event.target.closest(".indicator-menu")) {
          const dropdowns =
            document.getElementsByClassName("indicator-dropdown");
          const buttons = document.querySelectorAll(
            ".indicator-menu button.button"
          );

          for (let i = 0; i < dropdowns.length; i++) {
            dropdowns[i].classList.remove("show");
          }

          buttons.forEach((button) => button.classList.remove("active"));
        }
      };

      function addIndicator(type) {
        const plotDiv = document.getElementById("my-plot-id");
        const mainTrace = plotDiv.data.find(
          (t) => t.type === "scatter" || t.type === "candlestick"
        );

        if (!mainTrace) {
          console.error("Main price trace not found");
          return;
        }

        const yValues =
          mainTrace.type === "candlestick" ? mainTrace.close : mainTrace.y;
        const dataPoints = mainTrace.x.map((x, index) => ({
          x,
          y: yValues[index],
        }));

        let indicatorData, traceConfig;
        const period = type === "rsi" ? 14 : 20; // RSI uses 14 period by default

        // Add these new indicator calculation functions
        function calculateMACD(
          data,
          fastPeriod = 12,
          slowPeriod = 26,
          signalPeriod = 9
        ) {
          const fastEMA = calculateEMA(data, fastPeriod);
          const slowEMA = calculateEMA(data, slowPeriod);

          // Align the EMA arrays
          const macdLine = fastEMA
            .slice(slowPeriod - fastPeriod)
            .map((v, i) => ({
              x: v.x,
              y: v.y - slowEMA[i].y,
            }));

          const signalLine = calculateEMA(macdLine, signalPeriod);

          const histogram = macdLine.slice(signalPeriod - 1).map((v, i) => ({
            x: v.x,
            y: v.y - signalLine[i].y,
          }));

          return { macdLine, signalLine, histogram };
        }

        function calculateBollingerBands(data, period = 20, multiplier = 2) {
          const sma = calculateSMA(data, period);
          const bands = [];

          for (let i = period - 1; i < data.length; i++) {
            const slice = data.slice(i - period + 1, i + 1);
            const mean = sma[i - period + 1].y;
            const stdDev = Math.sqrt(
              slice.reduce((sum, d) => sum + Math.pow(d.y - mean, 2), 0) /
                period
            );

            bands.push({
              x: data[i].x,
              upper: mean + multiplier * stdDev,
              lower: mean - multiplier * stdDev,
              sma: mean,
            });
          }

          return bands;
        }

        switch (type) {
          case "rsi":
            indicatorData = calculateRSI(dataPoints, period);
            traceConfig = {
              x: indicatorData.map((d) => d.x),
              y: indicatorData.map((d) => d.y),
              type: "scatter",
              mode: "lines",
              name: `RSI (${period})`,
              line: { color: "#FFA500", width: 1.5 },
              yaxis: "y2",
            };

            // Check if subplot exists
            const hasSubplot = plotDiv.layout && plotDiv.layout.grid;

            if (!hasSubplot) {
              // Create subplot layout
              Plotly.relayout("my-plot-id", {
                grid: { rows: 2, cols: 1, pattern: "independent" },
                yaxis: { domain: [0.3, 1] }, // Main chart takes 70% height
                yaxis2: {
                  domain: [0, 0.25], // RSI takes 25% height
                  title: "RSI",
                  range: [0, 100],
                  showgrid: true,
                  gridcolor: "rgba(255,255,255,0.1)",
                },
                xaxis2: {
                  anchor: "y2",
                  matches: "x",
                  showticklabels: true,
                },
              });
            }

            // Toggle RSI
            const existingIndex = plotDiv.data.findIndex(
              (t) => t.name === traceConfig.name
            );
            if (existingIndex !== -1) {
              Plotly.deleteTraces("my-plot-id", existingIndex);
              // Remove subplot if no other indicators
              if (!plotDiv.data.some((t) => t.yaxis === "y2")) {
                Plotly.relayout("my-plot-id", {
                  grid: undefined,
                  yaxis: { domain: [0, 1] },
                  yaxis2: undefined,
                  xaxis2: undefined,
                });
              }
            } else {
              Plotly.addTraces("my-plot-id", traceConfig);
            }
            break;

          case "sma":
            indicatorData = calculateSMA(dataPoints, period);
            traceConfig = {
              x: indicatorData.map((d) => d.x),
              y: indicatorData.map((d) => d.y),
              type: "scatter",
              mode: "lines",
              name: `SMA (${period})`,
              line: { color: "#FF6B6B", width: 1.5 },
              yaxis: "y",
            };
            // Add explicit trace toggle for SMA
            const existingSMA = plotDiv.data.findIndex(
              (t) => t.name === traceConfig.name
            );

            console.log(existingSMA);

            if (existingSMA !== -1) {
              Plotly.deleteTraces("my-plot-id", existingSMA);
            } else {
              Plotly.addTraces("my-plot-id", traceConfig);
            }
            break;

          case "ema":
            indicatorData = calculateEMA(dataPoints, period);
            traceConfig = {
              x: indicatorData.map((d) => d.x),
              y: indicatorData.map((d) => d.y),
              type: "scatter",
              mode: "lines",
              name: `EMA (${period})`,
              line: { color: "#4ECDC4", width: 1.5, dash: "dot" },
              yaxis: "y",
            }; // Add explicit trace toggle for EMA
            const existingEMA = plotDiv.data.findIndex(
              (t) => t.name === traceConfig.name
            );
            if (existingEMA !== -1) {
              Plotly.deleteTraces("my-plot-id", existingEMA);
            } else {
              Plotly.addTraces("my-plot-id", traceConfig);
            }
            break;

          case "macd":
            const { macdLine, signalLine, histogram } =
              calculateMACD(dataPoints);

            // MACD Line
            let macdTrace = {
              x: macdLine.map((d) => d.x),
              y: macdLine.map((d) => d.y),
              type: "scatter",
              mode: "lines",
              name: "MACD Line",
              line: { color: "#26a69a", width: 1.5 },
              yaxis: "y3",
            };

            // Signal Line
            let signalTrace = {
              x: signalLine.map((d) => d.x),
              y: signalLine.map((d) => d.y),
              type: "scatter",
              mode: "lines",
              name: "Signal Line",
              line: { color: "#ff6d00", width: 1.5 },
              yaxis: "y3",
            };

            // Histogram
            let histTrace = {
              x: histogram.map((d) => d.x),
              y: histogram.map((d) => d.y),
              type: "bar",
              name: "MACD Histogram",
              marker: { color: "#7e57c2" },
              yaxis: "y3",
            };

            // Check for existing MACD traces
            const existingMACD = plotDiv.data.findIndex(
              (t) => t.name === "MACD Line"
            );

            if (existingMACD !== -1) {
              Plotly.deleteTraces("my-plot-id", [
                existingMACD,
                existingMACD + 1,
                existingMACD + 2,
              ]);
              // Remove subplot if no other indicators
              if (!plotDiv.data.some((t) => t.yaxis === "y3")) {
                Plotly.relayout("my-plot-id", {
                  grid: undefined,
                  yaxis3: undefined,
                  xaxis3: undefined,
                });
              }
            } else {
              // Create subplot layout
              Plotly.relayout("my-plot-id", {
                grid: { rows: 3, cols: 1, pattern: "independent" },
                yaxis: { domain: [0.5, 1] }, // Main chart
                yaxis2: { domain: [0.25, 0.45] }, // RSI
                yaxis3: { domain: [0, 0.2] }, // MACD
                xaxis3: {
                  anchor: "y3",
                  matches: "x",
                  showticklabels: true,
                },
              });

              Plotly.addTraces("my-plot-id", [
                macdTrace,
                signalTrace,
                histTrace,
              ]);
            }
            break;

          case "bollinger":
            const bbData = calculateBollingerBands(dataPoints);

            // Upper Band
            let upperTrace = {
              x: bbData.map((d) => d.x),
              y: bbData.map((d) => d.upper),
              type: "scatter",
              mode: "lines",
              name: "Bollinger Upper",
              line: { color: "#26a69a", width: 1, dash: "dot" },
              yaxis: "y",
            };

            // Lower Band
            let lowerTrace = {
              x: bbData.map((d) => d.x),
              y: bbData.map((d) => d.lower),
              type: "scatter",
              mode: "lines",
              name: "Bollinger Lower",
              line: { color: "#ef5350", width: 1, dash: "dot" },
              yaxis: "y",
            };

            // SMA Line
            let smaTrace = {
              x: bbData.map((d) => d.x),
              y: bbData.map((d) => d.sma),
              type: "scatter",
              mode: "lines",
              name: "Bollinger SMA",
              line: { color: "#787b86", width: 1 },
              yaxis: "y",
            };

            // Fill between bands
            let fillTrace = {
              x: bbData.map((d) => d.x),
              y: bbData.map((d) => d.upper),
              type: "scatter",
              mode: "none",
              name: "Bollinger Band",
              fill: "tonexty",
              fillcolor: "rgba(120, 123, 134, 0.1)",
              yaxis: "y",
            };

            // Check existing Bollinger traces
            const existingBB = plotDiv.data.findIndex(
              (t) => t.name === "Bollinger Upper"
            );

            if (existingBB !== -1) {
              Plotly.deleteTraces("my-plot-id", [
                existingBB,
                existingBB + 1,
                existingBB + 2,
                existingBB + 3,
              ]);
            } else {
              Plotly.addTraces("my-plot-id", [
                upperTrace,
                lowerTrace,
                smaTrace,
                fillTrace,
              ]);
            }
            break;

          // Add other indicator cases here

          default:
            console.warn("Unknown indicator type:", type);
            return;
        }

        // Plotly.addTraces("my-plot-id", traceConfig);
        document.getElementById("indicatorDropdown").classList.remove("show");
      }

      // Add generation timestamp
      document.getElementById("timestamp").textContent =
        new Date().toLocaleString();

      let isLogScale = false;

      function toggleLogScale() {
        const btn = document.getElementById("logScaleBtn");
        isLogScale = !isLogScale;

        // Update button state
        btn.classList.toggle("active", isLogScale);
        btn.querySelector("span").textContent = isLogScale
          ? "Linear Scale"
          : "Log Scale";

        // Animate icon
        btn.querySelector("svg").style.transform = `rotate(${
          isLogScale ? "180deg" : "0deg"
        })`;

        // Update plot
        Plotly.relayout("my-plot-id", {
          "yaxis.type": isLogScale ? "log" : "linear",
          "yaxis.title": "Price",
          "xaxis.title": "Date",
        });

        // Add visual feedback
        // animateScaleChange();
      }

      function animateScaleChange() {
        const plot = document.getElementById("my-plot-id");
        if (plot) {
          plot.style.opacity = "0.8";
          plot.style.transform = "scale(0.98)";
          setTimeout(() => {
            plot.style.opacity = "1";
            plot.style.transform = "scale(1)";
          }, 200);
        }
      }
    </script>
  </body>
</html>
